#!/bin/bash

sudo apt update -qq
sudo apt install -y -qq zip unzip wget curl

# Crear carpeta de servidor si no existe:
mkdir -p ~/server
cd ~/server

# ======================================== #
# ========== CONFIGURACIÃ“N =============== #
# ======================================== #
BEDROCK_VERSION="latest"
SERVERNAME="Bedrock Dedicated Server"
GAMEMODE="survival"
DIFFICULTY="easy"
CHEATS="false"

# ======================================== #
# ====== DESCARGA DEL SERVIDOR BDS ======= #
# ======================================== #

RANDVERSION=$(echo $((1 + $RANDOM % 4000)))

if [ "$BEDROCK_VERSION" == "latest" ]; then
    echo -e "\nðŸ” Descargando Ãºltima versiÃ³n de Bedrock Server..."
    curl -sL \
        -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
        -o versions.html.gz \
        "https://www.minecraft.net/en-us/download/server/bedrock"

    DOWNLOAD_URL=$(zgrep -o 'https://minecraft.azureedge.net/bin-linux/[^"]*' versions.html.gz | head -1)

    if [ -z "$DOWNLOAD_URL" ]; then
        echo "âŒ ERROR: No se pudo obtener la URL de descarga."
        exit 1
    fi
else
    echo -e "\n Descargando version especÃ­fica: $BEDROCK_VERSION"
    DOWNLOAD_URL="https://minecraft.azureedge.net/bin-linux/$BEDROCK_VERSION.zip"
fi

DOWNLOAD_FILE=$(basename "$DOWNLOAD_URL")

# ======================================== #
# ========== BACKUP DE ARCHIVOS ========== #
# ======================================== #

echo "ðŸ“¦ Realizando respaldos..."
[ -f server.properties ] && cp server.properties server.properties.bak
[ -f permissions.json ] && cp permissions.json permissions.json.bak
[ -f whitelist.json ] && cp whitelist.json whitelist.json.bak

rm -f versions.html.gz

echo "â¬‡ Descargando: $DOWNLOAD_URL"
curl -sL -o "$DOWNLOAD_FILE" "$DOWNLOAD_URL"

echo "ðŸ“¤ Extrayendo archivos..."
unzip -o "$DOWNLOAD_FILE" >/dev/null

echo "ðŸ§¹ Limpiando archivos..."
rm -f "$DOWNLOAD_FILE"

echo "â™» Restaurando configuraciÃ³n si existe..."
[ -f server.properties.bak ] && cp server.properties.bak server.properties
[ -f permissions.json.bak ] && cp permissions.json.bak permissions.json
[ -f whitelist.json.bak ] && cp whitelist.json.bak whitelist.json

chmod +x bedrock_server

echo "âœ… Servidor Bedrock instalado correctamente."


# ======================================== #
# ======== INSTALAR PLAYIT.GG ============ #
# ======================================== #

echo "â¬‡ Instalando Playit.gg (Ãºltima versiÃ³n)..."

wget -q "https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64" -O playit
chmod +x playit

echo "âœ… Playit.gg instalado correctamente."
echo ""
echo "ðŸŽ‰ InstalaciÃ³n completa."
echo ""
echo "-- Â¿Deseas iniciar el servidor ahora? --"
echo "1) SÃ­"
echo "2) No"

read -r opcion


if [ "$opcion" == "1" ]; then
    echo "Iniciando servidor..."
    ./bedrock_server
fi
